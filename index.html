<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Dashboard</title>

  <!-- Firebase SDKs (v10 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";

    import { firebaseConfig } from "./config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const allowedEmails = ["your.email@example.com"]; // Replace with authorized emails
    let currentUser = null;

    // DOM Elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const taskForm = document.getElementById("taskForm");
    const taskInput = document.getElementById("taskInput");
    const statusSelect = document.getElementById("statusSelect");
    const prioritySelect = document.getElementById("prioritySelect");
    const dueDateInput = document.getElementById("dueDateInput");
    const accessDeniedMsg = document.getElementById("accessDenied");
    const userDisplay = document.getElementById("userDisplay");

    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); } 
      catch (error) { console.error("Sign-in error:", error); alert("Google Sign-In failed."); }
    };

    logoutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const normalizedAllowed = allowedEmails.map(e => e.toLowerCase().trim());
        const normalizedUser = user.email.toLowerCase().trim();

        if (!normalizedAllowed.includes(normalizedUser)) {
          accessDeniedMsg.style.display = "block";
          loginBtn.disabled = true;
          taskForm.style.display = "none";
          userDisplay.textContent = `Signed in as: ${user.email} (unauthorized)`;
          logoutBtn.style.display = "inline-block";
          return;
        }

        currentUser = user;
        accessDeniedMsg.style.display = "none";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        taskForm.style.display = "block";
        userDisplay.textContent = `Welcome, ${user.displayName || user.email}`;
        loadTasks();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline-block";
        loginBtn.disabled = false;
        logoutBtn.style.display = "none";
        taskForm.style.display = "none";
        userDisplay.textContent = "";
        clearColumns();
      }
    });

    function clearColumns() {
      ["backlog", "inprogress", "done"].forEach(id => {
        document.getElementById(id).innerHTML = `<h3>${id.charAt(0).toUpperCase() + id.slice(1)}</h3>`;
      });
    }

    function getTaskColor(dueDate) {
      if (!dueDate) return "";
      const today = new Date().toISOString().split("T")[0];
      if (dueDate === today) return "background-color: orange;";
      if (dueDate < today) return "background-color: red; color: white;";
      return "";
    }

    async function loadTasks() {
      clearColumns();
      if (!currentUser) return;

      const q = query(collection(db, "tasks"), where("uid", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      const tasks = [];
      snapshot.forEach(docSnap => tasks.push({ id: docSnap.id, ...docSnap.data() }));

      // Sort by priority -> due date -> text
      const prioOrder = { high: 0, medium: 1, low: 2 };
      tasks.sort((a, b) => {
        if (prioOrder[a.priority] !== prioOrder[b.priority]) return prioOrder[a.priority] - prioOrder[b.priority];
        const da = a.dueDate ? new Date(a.dueDate) : null;
        const db = b.dueDate ? new Date(b.dueDate) : null;
        if (da && db) return da - db;
        if (da && !db) return -1;
        if (!da && db) return 1;
        return (a.text || "").localeCompare(b.text || "");
      });

      tasks.forEach(task => renderTask(task));
    }

    function renderTask(task) {
      const priorityIcon = task.priority === "high" ? "游댮" :
                           task.priority === "medium" ? "游리" : "游릭";

      const taskElement = document.createElement("div");
      taskElement.className = "task";
      taskElement.draggable = true;
      taskElement.ondragstart = (e) => drag(e, task.id);
      taskElement.style = getTaskColor(task.dueDate);

      taskElement.innerHTML = `
        <button class="delete-task" onclick="deleteTask('${task.id}')">X</button>
        <strong>${priorityIcon} ${task.text}</strong><br>
        <small>Due: ${task.dueDate || "No date"}</small><br>
        <button onclick="editTask('${task.id}', '${task.text}', '${task.priority}', '${task.dueDate}', '${task.status}')">
          九勇 Edit
        </button>
        <div class="comments" id="comments-${task.id}"></div>
        <div class="add-comment">
          <input type="text" id="commentInput-${task.id}" placeholder="Add comment...">
          <button onclick="addComment('${task.id}')">Add</button>
        </div>
      `;

      document.getElementById(task.status).appendChild(taskElement);
      if (task.comments) {
        task.comments.forEach((c, idx) => {
          const commentEl = document.createElement("div");
          commentEl.className = "comment";
          commentEl.innerHTML = `${c} <button class="delete-comment" onclick="deleteComment('${task.id}', ${idx})">X</button>`;
          document.getElementById(`comments-${task.id}`).appendChild(commentEl);
        });
      }
    }

    window.addTask = async function () {
      const text = taskInput.value;
      const status = statusSelect.value;
      const priority = prioritySelect.value;
      const dueDate = dueDateInput.value;

      if (!text.trim() || !currentUser) return;

      await addDoc(collection(db, "tasks"), {
        uid: currentUser.uid,
        text,
        status,
        priority,
        dueDate,
        comments: []
      });

      taskInput.value = "";
      dueDateInput.value = "";
      loadTasks();
    };

    window.deleteTask = async function (id) {
      await deleteDoc(doc(db, "tasks", id));
      loadTasks();
    };

    window.editTask = async function(id, text, priority, dueDate, status) {
      const newText = prompt("Edit task:", text) || text;
      const newPriority = prompt("Priority (low, medium, high):", priority) || priority;
      const newDueDate = prompt("Due date (YYYY-MM-DD):", dueDate) || dueDate;
      const newStatus = prompt("Status (backlog, inprogress, done):", status) || status;

      await updateDoc(doc(db, "tasks", id), {
        text: newText,
        priority: newPriority,
        dueDate: newDueDate,
        status: newStatus
      });

      loadTasks();
    };

    window.addComment = async function(taskId) {
      const input = document.getElementById(`commentInput-${taskId}`);
      const commentText = input.value;
      if (!commentText.trim()) return;

      const taskRef = doc(db, "tasks", taskId);
      const taskSnap = await getDocs(query(collection(db, "tasks"), where("uid", "==", currentUser.uid)));
      await updateDoc(taskRef, {
        comments: [...(taskSnap.docs.find(d => d.id === taskId)?.data().comments || []), commentText]
      });

      input.value = "";
      loadTasks();
    };

    window.deleteComment = async function(taskId, idx) {
      const taskRef = doc(db, "tasks", taskId);
      const taskSnap = await getDocs(query(collection(db, "tasks"), where("uid", "==", currentUser.uid)));
      const comments = taskSnap.docs.find(d => d.id === taskId)?.data().comments || [];
      comments.splice(idx, 1);
      await updateDoc(taskRef, { comments });
      loadTasks();
    };

    function drag(event, id) {
      event.dataTransfer.setData("text", id);
    }

    function allowDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.add("dragover");
    }

    function drop(event, newStatus) {
      event.preventDefault();
      const id = event.dataTransfer.getData("text");
      updateDoc(doc(db, "tasks", id), { status: newStatus }).then(loadTasks);
      event.currentTarget.classList.remove("dragover");
    }
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; margin:0;}
    h2 { text-align:center; }
    .board { display:flex; justify-content:space-around; gap:20px; flex-wrap:wrap; margin-top:20px;}
    .column { background:#fff; border-radius:10px; padding:10px; width:30%; min-height:200px; box-shadow:0 2px 6px rgba(0,0,0,0.1); box-sizing:border-box; margin-bottom:20px;}
    .column.dragover { background:#e0f7fa; }
    .task { background:#fefefe; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:8px; position:relative; cursor:grab;}
    .delete-task { position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:0.8em; }
    .comments { margin-top:10px; padding-left:10px; border-left:2px solid #ddd; }
    .comment { font-size:0.9em; margin:4px 0; display:flex; justify-content:space-between; align-items:center; }
    .delete-comment { background:#dc3545; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.7em; margin-left:5px; }
    .add-comment input { width:70%; padding:5px; border:1px solid #ccc; border-radius:4px; }
    .add-comment button { padding:5px 10px; margin-left:5px; border:none; background:#007bff; color:white; border-radius:4px; cursor:pointer; }
    .add-task { text-align:center; margin-bottom:10px; }
    .add-task input, .add-task select, .add-task button { margin:5px; padding:8px; border-radius:4px; border:1px solid #ccc; }
    #loginBtn, #logoutBtn { margin:10px; padding:10px 20px; }
    #accessDenied { color:red; text-align:center; font-weight:bold; display:none; margin-top:20px; }
    #userDisplay { text-align:center; font-weight:bold; margin:10px 0; word-break:break-word; }

    @media(max-width:768px){ .column{width:100%;} .board{gap:10px;} .add-task input,.add-task select,.add-task button{width:95%;} }
  </style>
</head>
<body>
  <h2>Task Dashboard</h2>
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <div id="userDisplay"></div>
  <div id="accessDenied">游뛂 Access Denied: You are not authorized to use this dashboard.</div>

  <div class="add-task" id="taskForm" style="display:none;">
    <input type="text" id="taskInput" placeholder="Enter new task..." />
    <select id="statusSelect">
      <option value="backlog">Backlog</option>
      <option value="inprogress">In Progress</option>
      <option value="done">Done</option>
    </select>
    <select id="prioritySelect">
      <option value="low">游릭 Low</option>
      <option value="medium">游리 Medium</option>
      <option value="high">游댮 High</option>
    </select>
    <input type="date" id="dueDateInput" />
    <button onclick="addTask()">Add Task</button>
  </div>

  <div class="board">
    <div class="column" id="backlog" ondragover="allowDrop(event)" ondrop="drop(event,'backlog')"><h3>Backlog</h3></div>
    <div class="column" id="inprogress" ondragover="allowDrop(event)" ondrop="drop(event,'inprogress')"><h3>In Progress</h3></div>
    <div class="column" id="done" ondragover="allowDrop(event)" ondrop="drop(event,'done')"><h3>Done</h3></div>
  </div>
</body>
</html>
