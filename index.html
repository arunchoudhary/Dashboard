<script type="module">
  // ✅ Top-level imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc 
  } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";
  import { firebaseConfig } from "./config.js";

  // Firebase initialization
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const allowedEmails = ["your.email@example.com"];
  let currentUser = null;

  // ✅ DOM access inside DOMContentLoaded
  window.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const taskForm = document.getElementById("taskForm");
    const taskInput = document.getElementById("taskInput");
    const statusSelect = document.getElementById("statusSelect");
    const accessDeniedMsg = document.getElementById("accessDenied");
    const userDisplay = document.getElementById("userDisplay");

    loginBtn.onclick = async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); } 
      catch (error) { console.error(error); alert("Google Sign-In failed."); }
    };

    logoutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const normalizedAllowed = allowedEmails.map(e => e.toLowerCase().trim());
        const normalizedUser = user.email.toLowerCase().trim();

        if (!normalizedAllowed.includes(normalizedUser)) {
          accessDeniedMsg.style.display = "block";
          loginBtn.disabled = true;
          taskForm.style.display = "none";
          userDisplay.textContent = `Signed in as: ${user.email} (unauthorized)`;
          logoutBtn.style.display = "inline-block";
          return;
        }

        currentUser = user;
        accessDeniedMsg.style.display = "none";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        loginBtn.disabled = false;
        taskForm.style.display = "block";
        userDisplay.textContent = `Welcome, ${user.displayName || user.email}`;
        loadTasks();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline-block";
        loginBtn.disabled = false;
        logoutBtn.style.display = "none";
        taskForm.style.display = "none";
        userDisplay.textContent = "";
        clearColumns();
      }
    });

    function clearColumns() {
      ["backlog", "inprogress", "done"].forEach(id => {
        document.getElementById(id).innerHTML = `<h3>${id.charAt(0).toUpperCase() + id.slice(1)}</h3>`;
      });
    }

    async function loadTasks() {
      clearColumns();
      if (!currentUser) return;

      const q = query(collection(db, "tasks"), where("uid", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      snapshot.forEach((docSnap) => {
        const task = docSnap.data();
        const taskElement = document.createElement("div");
        taskElement.className = "task";
        taskElement.innerHTML = `
          <button class="delete-task" onclick="deleteTask('${docSnap.id}')">X</button>
          <strong>${task.text}</strong>
        `;
        document.getElementById(task.status).appendChild(taskElement);
      });
    }

    window.addTask = async function () {
      const text = taskInput.value;
      const status = statusSelect.value;
      if (!text.trim() || !currentUser) return;

      await addDoc(collection(db, "tasks"), {
        uid: currentUser.uid,
        text,
        status
      });

      taskInput.value = "";
      loadTasks();
    };

    window.deleteTask = async function (id) {
      await deleteDoc(doc(db, "tasks", id));
      loadTasks();
    };
  });
</script>
